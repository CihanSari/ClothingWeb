<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="resources/css/clothing.css">
    <link rel="icon" href="resources/icons/clothingfork.ico">
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fabric.js/1.7.20/fabric.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/color-thief/2.0.1/color-thief.min.js"></script>
    <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="js/clothCanvas.js"></script>
    <script src="js/clothProgressBar.js"></script>
    <script src="js/clothFiles.js"></script>
    <script src="js/clothingBase.js"></script>
    <script src="js/showPaintingsOnCanvasAnnotated.js"></script>
    <title>Clothing</title>
</head>

<body>
    <article>
        <h1>Clothing Graph</h1>
        <div id="progressbar" class="progressBar">
            <span class="progressBarText">Loading...</span>
        </div>

        <fieldset style='margin-left:auto;margin-right:auto;width:500px;'>
            <label for="clustering" style='width:250px;'>Select a color extraction method</label>
            <select name="clustering" id="clustering">
                <option selected="selected">Annotated</option>
                <option>IMoFA</option>
                <option>k2</option>
                <option>k5</option>
                <option>k8</option>
                <option>k11</option>
                <option>k14</option>
                <option>k17</option>
            </select>
            <label for="graphMethod" style='width:250px;'>Select a plot method</label>
            <select name="graphMethod" id="graphMethod">
                <option selected="selected">Hue</option>
                <option>Color</option>
                <option>Portrait</option>
            </select>
            <a id="editEditor" href="javascript:void(0)">Advanced graph settings</a>
        </fieldset>
        <script>$(function () {
                $("#clustering").selectmenu({
                    change: function (event, data) {
                        const method = $('#clustering').val();
                        window.settings.clustering = method.toLowerCase();
                        window.clothing.drawResults();
                    }
                });
                $("#graphMethod").selectmenu({
                    change: function (event, data) {
                        const method = $('#graphMethod').val();
                        window.settings.graphMethod = method.toLowerCase();
                        window.clothing.drawResults();
                    }
                });
                setTimeout(() => {
                    if (window.settings.clustering == 'imofa') {
                        $('#clustering').val('IMoFA');
                    }
                    else if (window.settings.clustering == 'annotated') {
                        $('#clustering').val('Annotated');
                    } else {
                        $('#clustering').val(window.settings.clustering);
                    }
                    $("#clustering").selectmenu("refresh");
                    if (window.settings.graphMethod == 'hue') {
                        $('#graphMethod').val('Hue');
                    }
                    else if (window.settings.graphMethod == 'color') {
                        $('#graphMethod').val('Color');
                    }
                    else if (window.settings.graphMethod == 'portrait') {
                        $('#graphMethod').val('Portrait');
                    }
                    else {
                        alert(`Unknown graph method: ${window.settings.graphMethod}!`);
                    }
                    $("#graphMethod").selectmenu("refresh");
                }, 500);
            });</script>
        <canvas id="femaleCanvasHSI" width="1400" height="200"></canvas>
        <canvas id="femaleCanvasMonochrome" width="1400" height="150"></canvas>
        <canvas id="maleCanvasHSI" width="1400" height="200"></canvas>
        <canvas id="maleCanvasMonochrome" width="1400" height="150"></canvas>
    </article>
    <footer></footer>
    <script>
        function updateCluster(c1, c2) {
            // c1 and c2 has first element weight, rest of the values will be scaled off the weights...
            const cOut = [c1[0] + c2[0]];

            const fncUpdateValueWithWeight = (x1, w1, x2, w2) => (x1 * w1 + x2 * w2) / (w1 + w2);

            for (let i = 1; i < c1.length; i += 1) {
                cOut[i] = fncUpdateValueWithWeight(c1[i], c1[0], c2[i], c2[0]);
            }
            return cOut;
        }
        function displayFiles(files) {
            const fncProgressGenCallback = () => window.clothing.progressBar.fncProgressGenCallback();
            $.getJSON('data/json/filesImofa.json', annotatedFileList => {
                const areaThreshold = 0.1;
                const hueGroupThreshold = 30;
                const intGroupThreshold = 0.2;
                for (let idxFile = 0; idxFile < annotatedFileList.length; idxFile += 10) {
                    if (annotatedFileList[idxFile] != null) {
                        const idxFiles = annotatedFileList[idxFile].Index;
                        const imofaColors = annotatedFileList[idxFile].imofaColor;
                        const imofaHueCenters = [];
                        const imofaIntCenters = [];
                        for (let idxColor = 0; idxColor < imofaColors.length; idxColor += 1) {
                            const [weight, h1, h2, saturation, intensity] = imofaColors[idxColor];
                            const hue = getDominantColorFromH1H2SI([h1, h2, saturation, intensity])[0];
                            if (checkIfHue(hue, saturation, intensity)) {
                                let assignedToACluster = false;
                                for (let idxHueCenter = 0; idxHueCenter < imofaHueCenters.length; idxHueCenter += 1) {
                                    const [centerWeight, centerHue, centerSaturation, centerIntensity] = imofaHueCenters[idxHueCenter];
                                    let hueDif = (centerHue - hue) % 360;
                                    while (hueDif < 0) {
                                        hueDif += 360;
                                    }
                                    // Hue difference should be between 0 and 360 now...
                                    if (hueDif > (360 - hueGroupThreshold) || hueDif < hueGroupThreshold) {
                                        imofaHueCenters[idxHueCenter] = updateCluster(imofaHueCenters[idxHueCenter], [weight, hue, saturation, intensity]);
                                        assignedToACluster = true;
                                        break;
                                    }
                                }
                                if (!assignedToACluster) {
                                    // Did not assign to any cluster...
                                    imofaHueCenters.push([weight, hue, saturation, intensity]);
                                }
                            }
                            else {
                                let assignedToACluster = false;
                                for (let idxIntCenter = 0; idxIntCenter < imofaIntCenters.length; idxIntCenter += 1) {
                                    const [centerWeight, centerHue, centerSaturation, centerIntensity] = imofaIntCenters[idxIntCenter];
                                    if (Math.abs(centerIntensity - intensity) < intGroupThreshold) {
                                        imofaIntCenters[idxIntCenter] = updateCluster(imofaIntCenters[idxIntCenter], [weight, hue, saturation, intensity]);
                                        assignedToACluster = true;
                                        break;
                                    }
                                }
                                if (!assignedToACluster) {
                                    // Did not assign to any cluster...
                                    imofaHueCenters.push([weight, hue, saturation, intensity]);
                                }
                            }
                        }
                        imofaHueCenters.concat(imofaIntCenters);
                        imofaHueCenters.forEach(whsi => {
                            if (whsi[0] > areaThreshold) {
                                displayByIdx('data/json/' + files[idxFiles], idxFiles, [whsi[1], whsi[2], whsi[3]], fncProgressGenCallback())
                            }
                        });
                    }
                }
            });
        }
    </script>
</body>

</html>